{% extends "base.html" %}
{% block title %}Quality Check{% endblock %}
{% block content %}
<style>
    .product-list {
        max-height: 300px;
        overflow-y: auto;
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 5px;
        background: rgba(30, 35, 45, 0.8);
    }
    .product-item {
        padding: 10px;
        cursor: pointer;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }
    .product-item:hover {
        background-color: rgba(102, 126, 234, 0.3);
    }
    .product-item.selected {
        background-color: rgba(102, 126, 234, 0.5);
    }
    .product-item.hidden {
        display: none;
    }
</style>

<div class="row justify-content-center">
    <div class="col-md-10">
        <div class="card">
            <div class="card-body p-4">
                <h2 class="mb-4"><i class="bi bi-clipboard-check"></i> Quality Check</h2>
                
                <form id="qualityForm" method="POST">
                    <input type="hidden" name="product_id" id="selectedProductId">
                    
                    <div class="row g-3">
                        <div class="col-12">
                            <label class="form-label">Search & Select Product</label>
                            <div class="input-group mb-2">
                                <input type="text" id="productSearch" class="form-control" placeholder="Type to search by ID, Plant, or Product name..." autocomplete="off">
                                <button type="button" class="btn btn-outline-secondary" onclick="clearSearch()">
                                    <i class="bi bi-x-circle"></i> Clear
                                </button>
                            </div>
                            
                            <div class="product-list" id="productList">
                                {% for product in products %}
                                <div class="product-item" 
                                     data-id="{{ product.id }}" 
                                     data-search="{{ product.id|lower }} {{ product.plant|lower }} {{ product.product|lower }}"
                                     onclick="selectProduct('{{ product.id }}')">
                                    <strong>{{ product.id }}</strong> - {{ product.plant }} - {{ product.product }}
                                </div>
                                {% endfor %}
                            </div>
                            
                            <small class="text-muted">Showing <span id="productCount">{{ products|length }}</span> of {{ products|length }} products</small>
                            <div id="selectedProductDisplay" class="mt-2 alert alert-info" style="display:none;">
                                <strong>Selected:</strong> <span id="selectedProductText"></span>
                            </div>
                        </div>
                        
                        <div class="col-12"><hr class="my-2"></div>
                        <div class="col-12"><h5>Current Measurements</h5></div>
                        
                        <div class="col-md-6">
                            <label class="form-label">Moisture</label>
                            <input type="number" step="0.01" name="moisture" id="moisture" class="form-control" required>
                            <small class="text-muted" id="moisture-range">Select product to see range</small>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Weight</label>
                            <input type="number" step="0.01" name="weight" id="weight" class="form-control" required>
                            <small class="text-muted" id="weight-range">Select product to see range</small>
                        </div>
                        
                        <div class="col-md-6">
                            <label class="form-label">Thickness</label>
                            <input type="number" step="0.01" name="thickness" id="thickness" class="form-control" required>
                            <small class="text-muted" id="thickness-range">Select product to see range</small>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Breadth</label>
                            <input type="number" step="0.01" name="breadth" id="breadth" class="form-control" required>
                            <small class="text-muted" id="breadth-range">Select product to see range</small>
                        </div>
                        
                        <div class="col-md-6">
                            <label class="form-label">Length</label>
                            <input type="number" step="0.01" name="length" id="length" class="form-control" required>
                            <small class="text-muted" id="length-range">Select product to see range</small>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Diameter</label>
                            <input type="number" step="0.01" name="diameter" id="diameter" class="form-control" required>
                            <small class="text-muted" id="diameter-range">Select product to see range</small>
                        </div>
                        
                        <div class="col-12 mt-4">
                            <button type="button" class="btn btn-success" onclick="confirmSubmit()">
                                <i class="bi bi-check-circle"></i> Submit Quality Check
                            </button>
                            <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">Cancel</a>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Confirmation Modal -->
<div class="modal fade" id="confirmModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-exclamation-triangle"></i> Confirm Submission</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p><strong>Product:</strong> <span id="confirm-product"></span></p>
                <p><strong>Inspector:</strong> {{ session.username }}</p>
                <p><strong>Date/Time:</strong> <span id="confirm-datetime"></span></p>
                <hr>
                <h6>Measurements:</h6>
                <ul id="confirm-measurements"></ul>
                <div id="confirm-warnings" class="alert alert-warning" style="display:none;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="submitForm()">
                    <i class="bi bi-check-circle"></i> Confirm & Submit
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let productSpecs = null;
let selectedProduct = null;

// Search and filter products
document.getElementById('productSearch').addEventListener('keyup', function() {
    const searchText = this.value.toLowerCase().trim();
    const items = document.querySelectorAll('.product-item');
    let visibleCount = 0;
    
    items.forEach(item => {
        const searchData = item.getAttribute('data-search');
        if (searchData.includes(searchText)) {
            item.classList.remove('hidden');
            visibleCount++;
        } else {
            item.classList.add('hidden');
        }
    });
    
    document.getElementById('productCount').textContent = visibleCount;
});

function clearSearch() {
    document.getElementById('productSearch').value = '';
    const items = document.querySelectorAll('.product-item');
    items.forEach(item => item.classList.remove('hidden'));
    document.getElementById('productCount').textContent = items.length;
    
    // Clear selection
    document.getElementById('selectedProductId').value = '';
    document.getElementById('selectedProductDisplay').style.display = 'none';
    items.forEach(item => item.classList.remove('selected'));
    clearSpecs();
}

function selectProduct(productId) {
    // Update hidden field
    document.getElementById('selectedProductId').value = productId;
    
    // Update visual selection
    const items = document.querySelectorAll('.product-item');
    items.forEach(item => {
        if (item.getAttribute('data-id') === productId) {
            item.classList.add('selected');
            selectedProduct = item.textContent.trim();
            document.getElementById('selectedProductText').textContent = selectedProduct;
            document.getElementById('selectedProductDisplay').style.display = 'block';
        } else {
            item.classList.remove('selected');
        }
    });
    
    // Load product specs
    loadProductSpecs(productId);
}

function loadProductSpecs(productId) {
    if (!productId) {
        clearSpecs();
        return;
    }
    
    fetch(`/get-product-specs/${productId}`)
        .then(response => response.json())
        .then(data => {
            productSpecs = data;
            document.getElementById('moisture-range').innerHTML = `<strong>Range:</strong> ${data.moisture_min} - ${data.moisture_max}`;
            document.getElementById('weight-range').innerHTML = `<strong>Range:</strong> ${data.weight_min} - ${data.weight_max}`;
            document.getElementById('thickness-range').innerHTML = `<strong>Range:</strong> ${data.thickness_min} - ${data.thickness_max}`;
            document.getElementById('breadth-range').innerHTML = `<strong>Range:</strong> ${data.breadth_min} - ${data.breadth_max}`;
            document.getElementById('length-range').innerHTML = `<strong>Range:</strong> ${data.length_min} - ${data.length_max}`;
            document.getElementById('diameter-range').innerHTML = `<strong>Range:</strong> ${data.diameter_min} - ${data.diameter_max}`;
        });
}

function clearSpecs() {
    productSpecs = null;
    const ranges = ['moisture', 'weight', 'thickness', 'breadth', 'length', 'diameter'];
    ranges.forEach(r => {
        document.getElementById(`${r}-range`).textContent = 'Select product to see range';
    });
}

function confirmSubmit() {
    const productId = document.getElementById('selectedProductId').value;
    
    if (!productId) {
        alert('Please select a product first');
        return;
    }
    
    if (!document.getElementById('qualityForm').checkValidity()) {
        document.getElementById('qualityForm').reportValidity();
        return;
    }
    
    document.getElementById('confirm-product').textContent = selectedProduct;
    document.getElementById('confirm-datetime').textContent = new Date().toLocaleString();
    
    const measurements = {
        'Moisture': parseFloat(document.getElementById('moisture').value),
        'Weight': parseFloat(document.getElementById('weight').value),
        'Thickness': parseFloat(document.getElementById('thickness').value),
        'Breadth': parseFloat(document.getElementById('breadth').value),
        'Length': parseFloat(document.getElementById('length').value),
        'Diameter': parseFloat(document.getElementById('diameter').value)
    };
    
    let measurementsList = '';
    let warnings = [];
    
    Object.keys(measurements).forEach(key => {
        const value = measurements[key];
        const min = productSpecs[`${key.toLowerCase()}_min`];
        const max = productSpecs[`${key.toLowerCase()}_max`];
        const inSpec = value >= min && value <= max;
        const color = inSpec ? 'text-success' : 'text-danger';
        
        measurementsList += `<li class="${color}">${key}: ${value} (Spec: ${min} - ${max}) ${inSpec ? '✓' : '✗'}</li>`;
        
        if (!inSpec) {
            warnings.push(`${key} is out of specification`);
        }
    });
    
    document.getElementById('confirm-measurements').innerHTML = measurementsList;
    
    const warningDiv = document.getElementById('confirm-warnings');
    if (warnings.length > 0) {
        warningDiv.style.display = 'block';
        warningDiv.innerHTML = '<strong>⚠ Warning:</strong><br>' + warnings.join('<br>');
    } else {
        warningDiv.style.display = 'none';
    }
    
    const modal = new bootstrap.Modal(document.getElementById('confirmModal'));
    modal.show();
}

function submitForm() {
    document.getElementById('qualityForm').submit();
}
</script>
{% endblock %}